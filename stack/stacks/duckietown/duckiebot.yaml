version: '3.2'
services:

  dtps:
    image: ${REGISTRY}/duckietown/dtps-switchboard:release
    container_name: dtps
    restart: unless-stopped
    network_mode: host
    environment:
      RUST_LOG: "warn,dtps_http=info"
    command: --tcp-port 11511 --tcp-host 0.0.0.0 --unix-path /dtps/switchboard.sock
    privileged: true
    volumes:
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-camera:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-camera
    restart: unless-stopped
    network_mode: host
    privileged: true
    pid: host
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: sensor-camera
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      # nvargus socket
      - /tmp:/tmp

  driver-tof:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-tof
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: sensor-tof
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-imu:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-imu
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: sensor-imu
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-power-button:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-power-button
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: sensor-power-button
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-wheel-encoders:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-wheel-encoders
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: sensor-wheel-encoders
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-wheels:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-wheels
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: actuator-wheels
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-lights:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-lights
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: actuator-leds
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  driver-display:
    image: ${REGISTRY}/duckietown/dt-duckiebot-interface:ente-${ARCH}
    container_name: driver-display
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      DT_SUPERUSER: 1
      DT_LAUNCHER: actuator-display
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  dashboard:
    image: ${REGISTRY}/duckietown/dt-device-dashboard:ente-${ARCH}
    container_name: dashboard
    restart: unless-stopped
    network_mode: host
    environment:
      HTTP_PORT: 8080
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # secrets
      - /secrets:/secrets
      # compose volume
      - compose-data:/user-data/databases
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  files-api:
    image: ${REGISTRY}/duckietown/dt-files-api:ente-${ARCH}
    container_name: files-api
    restart: always
    network_mode: host
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # secrets
      - /secrets:/secrets
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  code-api:
    image: ${REGISTRY}/duckietown/dt-code-api:ente-${ARCH}
    container_name: code-api
    restart: always
    network_mode: host
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # user code
      - /code:/user_code
      # docker socket
      - /var/run/docker.sock:/var/run/docker.sock
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  device-proxy:
    image: ${REGISTRY}/duckietown/dt-device-proxy:ente-${ARCH}
    container_name: device-proxy
    restart: always
    network_mode: host
    environment:
      DT_SUPERUSER: 1
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  device-health:
    image: ${REGISTRY}/duckietown/dt-device-health:ente-${ARCH}
    container_name: device-health
    restart: always
    network_mode: host
    privileged: true
    environment:
      # needed to talk to the docker daemon socket
      DT_SUPERUSER: 1
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # triggers
      - /triggers:/triggers
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

  device-online:
    image: ${REGISTRY}/duckietown/dt-device-online:ente-${ARCH}
    container_name: device-online
    restart: always
    network_mode: host
    # needed to run threads in Python3.12 (https://forums.docker.com/t/runtimeerror-cant-start-new-thread/138142/2)
    privileged: true
    environment:
      # needed to talk to the docker daemon socket
      DT_SUPERUSER: 1
    volumes:
      - /data:/data
      # dtps sockets
      - /data/ramdisk/dtps:/dtps
      # secrets
      - /secrets:/secrets
      # docker socket
      - /var/run/docker.sock:/var/run/docker.sock
      # avahi socket
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket

volumes:
  compose-data:
